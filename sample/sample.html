<!DOCTYPE HTML>
<html>
	<head>
		<meta charset=utf-8>
		<script src="//d3js.org/d3.v3.min.js" charset="utf-8"></script>
		<script src="../dist/shogi-board.js" charset="utf-8"></script>
		<style>
		</style>
	</head>
	<body>
		<table id=theboard >
		</table>
		<table id=theboard2>
		</table>
		<div id=theboard3>
		</div>

		<script>
			var bd =
			[[["NK",1],["NY",1],["NG",1],["KI",1],["OU",1],["KI",1],["GI",1],["KE",1],["KY",1]]
			,[  null  ,["RY",1],  null  ,  null  ,  null  ,  null  ,  null  ,["UM",1],  null  ]
			,[["FU",1],["FU",1],["FU",1],["TO",1],["TO",1],["TO",1],["FU",1],["FU",1],["FU",1]]
			,[  null  ,  null  ,  null  ,  null  ,  null  ,  null  ,  null  ,  null  ,  null  ]
			,[  null  ,  null  ,  null  ,  null  ,  null  ,  null  ,  null  ,  null  ,  null  ]
			,[  null  ,  null  ,  null  ,  null  ,  null  ,  null  ,  null  ,  null  ,  null  ]
			,[["FU",0],["FU",0],["FU",0],["FU",0],["FU",0],["FU",0],["FU",0],["FU",0],["FU",0]]
			,[  null  ,["KA",0],  null  ,  null  ,  null  ,  null  ,  null  ,["HI",0],  null  ]
			,[["NK",0],["NY",0],["NG",0],["KI",0],["OU",0],["KI",0],["GI",0],["KE",0],["KY",0]]
			];
		</script>

		<script>(function() {
			var sel = d3.select("#theboard");
			sel.node().style.padding="11px 11px 10px"; // does not work
			sel.node().style.borderCollapse="collapse";
			sel.node().style.backgroundImage = "url(" + "../../" + ShogiBoard.preset.grid.dot_xy + ")";
			sel
				.selectAll("tr").data(bd)
				.enter().append("tr")
				.selectAll("td").data(d3.entries)
				.enter().append("td")
				.attr("style", "margin: 0; padding: 0")
				.each(function(d) {
					var value = d['value'];
					var src;
					if(value) {
						src = "../../" + ShogiBoard.preset.piece.ryoko_torafu[value[0]][value[1]];
					} else {
						src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACsAAAAwCAYAAACITIOYAAAAH0lEQVRo3u3BMQEAAADCoPVPbQZ/oAAAAAAAAAAAPgMgcAAB3kcvEQAAAABJRU5ErkJggg==";
					}
					var img = this.firstChild;
					if (img) {
						img.src = src;
					} else {
						img = document.createElement("img");
						img.src = src;
						this.appendChild(img);
					}
				})
			;
		})();</script>
		<script>
			var textmap =
			{"FU":"歩"
			,"GI":"銀"
			,"HI":"飛"
			,"KA":"角"
			,"KE":"桂"
			,"KI":"金"
			,"KY":"香"
			,"NG":"成銀"
			,"NK":"成香"
			,"NY":"成桂"
			,"OU":"玉"
			,"RY":"龍"
			,"TO":"と"
			,"UM":"馬"
			};
			var colormap =
			{"FU":"black"
			,"GI":"black"
			,"HI":"black"
			,"KA":"black"
			,"KE":"black"
			,"KI":"black"
			,"KY":"black"
			,"NG":"red"
			,"NK":"red"
			,"NY":"red"
			,"OU":"black"
			,"RY":"red"
			,"TO":"red"
			,"UM":"red"
			};
			var nummap = [null, '一','二','三','四','五','六','七','八','九','十'];
		</script>
		<script>(function() {
			var dhandler = function(d) {
				var value = d['value'];
				var div = document.createElement('div');
				var style = "font-size: 1.8em;";
				var transform = [];
				if (value && value[1] == 1) {
					transform.push("rotate(180deg)");
				}
				if (value) {
					var chs = textmap[value[0]].split('');
					var firstchar = true;
					for (var i = 0; i < chs.length; ++i) {
						if (firstchar) {
							firstchar = false;
						} else {
							div.appendChild(document.createElement('br'));
						}
						var c = chs[i];
						var span = document.createElement('span');
						var span_style = "display: inline-block;width:1em;";
						if (chs.length > 1) {
							span_style += "transform:scaleY(0.5);";
						}
						span.style = span_style;
						span.appendChild(document.createTextNode(c));
						div.appendChild(span);
					}
					if (chs.length > 1) {
						// transform.push("scaleY(0.5)");
						style += "line-height: 0.5;";
					}

					var color = colormap[value[0]];
					style += "color:" + color + ";";
				} else {
					div.appendChild(document.createTextNode(' '));
				}
				if (transform.length > 0) {
					style += "transform: " + transform.join(' ') + ';'
				}
				div.style = style;
				this.appendChild(div);
			};
			var sel = d3.select("#theboard2");
			sel.node().style.borderCollapse="collapse";
			sel
				.selectAll("tr").data(bd)
				.enter().append("tr")
				.selectAll("td").data(d3.entries)
				.enter().append("td")
				.attr("style", "margin: 0; padding: 0; border: solid black 1px; width: 2em; height: 2.5em; text-align: center; overflow: hidden;")
				.each(dhandler)
				;
		})();</script>
		<script>
			var pcs0 =
			[ ["TO",9,7] , ["TO",8,7] , ["TO",7,7]
			, ["FU",6,7] , ["FU",5,7] , ["FU",4,7]
			, ["FU",3,7] , ["FU",2,7] , ["FU",1,7]
			, ["UM",8,8] , ["HI",2,8]
			, ["NK",9,9] , ["KY",1,9]
			, ["NY",8,9] , ["KE",2,9]
			, ["NG",7,5] , ["GI",3,9]
			, ["KI",6,9] , ["KI",4,9]
			, ["OU",5,9]
			];
			var pcs1 =
			[ ["TO",1,3] , ["TO",2,3] , ["TO",3,3]
			, ["FU",4,3] , ["FU",5,3] , ["FU",6,3]
			, ["FU",7,3] , ["FU",8,3] , ["FU",9,3]
			, ["KA",2,2] , ["RY",8,2]
			, ["NK",1,1] , ["KY",9,1]
			, ["NY",2,4] , ["KE",8,1]
			, ["NG",3,1] , ["GI",7,1]
			, ["KI",4,1] , ["KI",6,1]
			, ["OU",5,1]
			];
			var hilite = [ 7, 5 ];
			var ps0 =
			{ "FU": 0
			, "KY": 0
			, "KE": 0
			, "GI": 0
			, "KI": 0
			, "KA": 0
			, "HI": 0
			};
			var ps1 =
			{ "FU": 18
			, "KY": 4
			, "KE": 4
			, "GI": 4
			, "KI": 4
			, "KA": 2
			, "HI": 2
			};
		</script>
		<script>(function() {
			var svgWidth = 420;
			var svgHeight = 360;
			var boardWidth = 300;
			var boardHeight = 330;
			var sel = d3.select("#theboard3");
			var svg = sel.append("svg")
			  .attr("width", svgWidth)
			  .attr("height", svgHeight)
			  ;
			var scX = d3.scale.linear().domain([9, 0]).range([45, boardWidth + 45]);
			var scY = d3.scale.linear().domain([0, 9]).range([20, boardHeight + 20]);
			svg.append("rect")
			  .attr("x", Math.min(scX(hilite[0]), scX(hilite[0] - 1)))
			  .attr("y", Math.min(scY(hilite[1]), scY(hilite[1] - 1)))
			  .attr("width", Math.abs(scX(hilite[0]) - scX(hilite[0] - 1)))
			  .attr("height", Math.abs(scY(hilite[1]) - scY(hilite[1] - 1)))
			  .attr("fill", "#CCFFAA")
			  ;
			svg.selectAll("line.gridX")
			  .data(d3.range(0, 9+1, 1))
			  .enter().append("line")
			  .attr("class", "gridX")
			  .attr("x1", function(d) { return scX(d) })
			  .attr("y1", scY(0))
			  .attr("x2", function(d) { return scX(d) })
			  .attr("y2", scY(9))
			  .attr("stroke", "black")
			  ;
			svg.selectAll("line.gridY")
			  .data(d3.range(0, 9+1, 1))
			  .enter().append("line")
			  .attr("class", "gridY")
			  .attr("x1", scX(0))
			  .attr("y1", function(d) { return scY(d) })
			  .attr("x2", scX(9))
			  .attr("y2", function(d) { return scY(d) })
			  .attr("stroke", "black")
			  ;
			svg.selectAll("circle.star")
			  .data([[3, 3], [3, 6], [6, 3], [6, 6]])
			  .enter().append("circle")
			  .attr("class", "star")
			  .attr("cx", function(d) { return scX(d[0]) })
			  .attr("cy", function(d) { return scY(d[1]) })
			  .attr("r", "3")
			  .attr("stroke", "black")
			  .attr("fill", "black")
			  ;
			svg.selectAll("text.gaugeX")
			  .data(['１','２','３','４','５','６','７','８','９'])
			  .enter().append("text").attr("class","gaugeX")
			  .attr("font-size",10)
			  .attr("text-anchor","middle")
			  // .attr("dominant-baseline","central")
			  .attr("x",function(d, i) { return scX(i + 0.5); })
			  .attr("y",scY(-0.2))
			  .text(function(d) { return d })
			  ;
			svg.selectAll("text.gaugeY")
			  .data(['一','二','三','四','五','六','七','八','九'])
			  .enter().append("text").attr("class","gaugeY")
			  .attr("font-size",10)
			  .attr("text-anchor","middle")
			  // .attr("dominant-baseline","central")
			  .attr("x",scX(-0.2))
			  .attr("y",function(d, i) { return scY(i + 0.5); })
			  .text(function(d) { return d })
			  ;
			var appendtext = function(d) {
				var g = d3.select(this);
				g.attr("font-size",30);

				var chs = textmap[d[0]].split('');
				var x = d[1] - 0.5;
				var y0 = d[2];

				for (var i = 0; i < chs.length; ++i) {
					var y = y0 - 1 + (i+0.8) /chs.length
					g.append("text")
					.attr("text-anchor","middle")
					// .attr("dominant-baseline","text-after-edge")
					.attr("x", scX(x))
					.attr("y", 0)
					.attr("fill", colormap[d[0]])
					.attr("transform", "matrix(" + [1, 0, 0, 1/Math.pow(chs.length,0.9), 0, scY(y)].join() + ")")
					.text(chs[i])
					;
				}
			};
			svg.selectAll("g.pcs0")
			  .data(pcs0)
			  .enter().append("g").attr("class","pcs0")
			  .each(appendtext)
			  ;
			svg.selectAll("g.pcs1")
			  .data(pcs1)
			  .enter().append("g").attr("class","pcs1")
			  .attr("transform", function(d) { return "rotate(" + [180, scX(d[1] - 0.5), scY(d[2] - 0.5)].join(' ') + ")" })
			  .each(appendtext)
			  ;
			var ps2textlist = function(playerlabel, ps) {
				var res = [];
				["HI","KA","KI","GI","KE","KY","FU"].forEach(function(k) {
					if(ps[k]) {
						res.push([textmap[k], 22]);
						if (ps[k] > 10) {
							res.push([nummap[10], 16]);
							res.push([nummap[ps[k] - 10], 16]);
						} else if (ps[k] > 2) {
							res.push([nummap[ps[k]], 20]);
						} else if (ps[k] == 2) {
							res.push([textmap[k], 22]);
						}
					}
				});
				if (res.length == 0) {
					res =
					[["持", 18]
					,["駒", 18]
					,["な", 18]
					,["し", 18]
					];
				}
				res.unshift([playerlabel, 25]);
				var y = 0 - res[0][1];
				for (var i = 0; i < res.length; ++i) {
					var h = res[i][1];
					y += h;
					res[i].push(y);
				}
				return res;
			};
			(function(g){
				var textlist = ps2textlist('\u2617', ps0);
				g
					.attr("text-anchor","middle")
					// .attr("dominant-baseline","text-after-edge")
					.attr("transform", "matrix(" + [1, 0, 0, 1, 25 + 45 + boardWidth, 20].join() + ")")
					;
				g.selectAll("text").data(textlist)
					.enter().append("text")
					.text(function(d){return d[0];})
					// .attr("transform", "matrix(" + [-1, 0, 0, 1, 0, 0].join() + ")")
					.attr("font-size", function(d) { return d[1]; })
					.attr("x", 0)
					.attr("y", function(d){ return d[2]; })
				;
			})(svg.append("g"));
			(function(g){
				var textlist = ps2textlist('\u2616', ps1);
				g
					.attr("text-anchor","middle")
					// .attr("dominant-baseline","text-after-edge")
					.attr("transform", "matrix(" + [1, 0, 0, -1, 25, boardHeight].join() + ")")
					;
				g.selectAll("text").data(textlist)
					.enter().append("text")
					.text(function(d){return d[0];})
					.attr("font-size", function(d) { return d[1]; })
					.attr("transform", "matrix(" + [-1, 0, 0, 1, 0, 0].join() + ")")
					.attr("x", 0)
					.attr("y", function(d){ return d[2]; })
				;
			})(svg.append("g"));
		})()</script>
	</body>
</html>
